name: Auto-Compile on Push

on:
  push:
    branches:
      - main
    paths:
      - 'app_gui.py'
      - 'scrapers/**'
      - 'src/**'
      - 'requirements.txt'
      - 'CatalogoGenerator_GUI.spec'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build .exe with PyInstaller
      run: |
        pyinstaller CatalogoGenerator_GUI.spec --distpath dist --workpath build --clean

    - name: Verify .exe exists
      run: |
        if (Test-Path "dist/CatalogoGenerator.exe") {
          Write-Host "âœ… CatalogoGenerator.exe created successfully!"
          $size = (Get-Item "dist/CatalogoGenerator.exe").Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ CatalogoGenerator.exe not found!"
          exit 1
        }

    - name: Get latest release info
      id: release
      run: |
        $latest = gh release view latest --json tagName,body 2>$null || echo "none"
        if ($latest -eq "none") {
          echo "exists=false" >> $env:GITHUB_OUTPUT
        } else {
          echo "exists=true" >> $env:GITHUB_OUTPUT
        }
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Delete previous release
      if: steps.release.outputs.exists == 'true'
      run: |
        gh release delete latest --yes
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Create Release
      run: |
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $commit_msg = git log -1 --pretty=%B
        gh release create latest dist/CatalogoGenerator.exe `
          --title "ðŸ“¦ Latest - CatÃ¡logo Generator" `
          --notes "Built: $timestamp`n`nCommit: $commit_msg`n`nâœ… Professional PyQt6 desktop interface`nâœ… Nike & Sephora tabs with real-time scraping`nâœ… Excel export with pricing calculations`nâœ… Auto-update capability`nâœ… Error logging to local file`nâœ… Product sizes detection"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Upload to existing release if create failed
      if: failure()
      run: |
        gh release upload latest dist/CatalogoGenerator.exe --clobber
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update version.txt
      run: |
        $timestamp = Get-Date -Format "yyyy.MM.dd-HHmm"
        $timestamp | Out-File -FilePath version.txt -Encoding UTF8 -NoNewline
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add version.txt
        git commit -m "AUTO: version bump to $timestamp" || true
        git push
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: âœ… Success
      run: |
        Write-Host "âœ… Build complete!"
        Write-Host "ðŸ“¦ Release: https://github.com/${{ github.repository }}/releases/tag/latest"

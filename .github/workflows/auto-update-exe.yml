name: Auto-Compile & Release on Push

on:
  push:
    branches:
      - main
    paths:
      - 'app_gui.py'
      - 'scrapers/**'
      - 'src/**'
      - 'requirements.txt'
      - 'CatalogoGenerator_GUI.spec'

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build .exe with PyInstaller
      run: |
        pyinstaller CatalogoGenerator_GUI.spec --distpath dist --workpath build --clean

    - name: Verify .exe exists
      run: |
        if (Test-Path "dist/CatalogoGenerator.exe") {
          Write-Host "‚úÖ CatalogoGenerator.exe created successfully!"
          $size = (Get-Item "dist/CatalogoGenerator.exe").Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "‚ùå CatalogoGenerator.exe not found!"
          exit 1
        }

    - name: Get commit message
      id: commit_msg
      run: |
        $msg = git log -1 --pretty=%B
        echo "message=$msg" >> $env:GITHUB_OUTPUT

    - name: Delete old 'latest' release if exists
      continue-on-error: true
      run: |
        gh release delete latest --yes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create/Update 'latest' Release with new .exe
      uses: softprops/action-gh-release@v1
      with:
        files: dist/CatalogoGenerator.exe
        tag_name: latest
        name: "üì¶ Latest Version - Cat√°logo Generator"
        body: |
          # Cat√°logo Generator - Latest Version
          
          **Last Update:** ${{ github.event.head_commit.timestamp }}
          
          **Commit:** ${{ steps.commit_msg.outputs.message }}
          
          ## What's Included
          - ‚úÖ Professional PyQt6 desktop interface
          - ‚úÖ Nike & Sephora tabs with real-time scraping
          - ‚úÖ Excel export with pricing calculations
          - ‚úÖ Auto-update capability
          - ‚úÖ Error logging to local file
          - ‚úÖ All dependencies bundled
          
          ## How to Update
          Open the app ‚Üí Settings ‚Üí Check for Updates ‚Üí Restart
          
          Built with ‚ù§Ô∏è using PyQt6, Selenium, Pandas
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update version file
      run: |
        $timestamp = Get-Date -Format "yyyy.MM.dd-HHmm"
        echo $timestamp | Out-File -FilePath version.txt -Encoding UTF8
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add version.txt
        git commit -m "AUTO: Update version timestamp to $timestamp" || true
        git push

    - name: Notify in commit
      run: |
        Write-Host "‚úÖ Compilation complete and released!"
        Write-Host "üì• New .exe available at: https://github.com/${{ github.repository }}/releases/tag/latest"

name: Auto-Compile & Release on Push

on:
  push:
    branches:
      - main
    paths:
      - 'app_gui.py'
      - 'scrapers/**'
      - 'src/**'
      - 'requirements.txt'
      - 'CatalogoGenerator_GUI.spec'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build .exe with PyInstaller
      run: |
        pyinstaller CatalogoGenerator_GUI.spec --distpath dist --workpath build --clean

    - name: Verify .exe exists
      run: |
        if (Test-Path "dist/CatalogoGenerator.exe") {
          Write-Host "‚úÖ CatalogoGenerator.exe created successfully!"
          $size = (Get-Item "dist/CatalogoGenerator.exe").Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "‚ùå CatalogoGenerator.exe not found!"
          exit 1
        }

    - name: Get commit message
      id: commit_msg
      run: |
        $msg = git log -1 --pretty=%B
        echo "message=$msg" >> $env:GITHUB_OUTPUT

    - name: Delete old 'latest' release if exists
      continue-on-error: true
      run: |
        gh release delete latest --yes --repo ${{ github.repository }}
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Create 'latest' Release with new .exe using gh CLI
      run: |
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $body = @"
        # Cat√°logo Generator - Latest Version
        
        **Last Update:** $timestamp
        
        **Commit:** $(git log -1 --pretty=%B)
        
        ## What's Included
        - ‚úÖ Professional PyQt6 desktop interface
        - ‚úÖ Nike & Sephora tabs with real-time scraping
        - ‚úÖ Excel export with pricing calculations
        - ‚úÖ Auto-update capability
        - ‚úÖ Error logging to local file
        - ‚úÖ Product sizes detection
        - ‚úÖ All dependencies bundled
        
        ## How to Update
        Open the app ‚Üí Settings ‚Üí Check for Updates ‚Üí Restart
        
        Built with ‚ù§Ô∏è using PyQt6, Selenium, Pandas
        "@
        
        gh release create latest "dist/CatalogoGenerator.exe" `
          --title "üì¶ Latest Version - Cat√°logo Generator" `
          --notes $body `
          --repo ${{ github.repository }} || `
        gh release upload latest "dist/CatalogoGenerator.exe" `
          --repo ${{ github.repository }} `
          --clobber
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Update version file
      run: |
        $timestamp = Get-Date -Format "yyyy.MM.dd-HHmm"
        $timestamp | Out-File -FilePath version.txt -Encoding UTF8
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add version.txt
        git commit -m "AUTO: Update version timestamp to $timestamp" || true
        git push
      env:
        GH_TOKEN: ${{ github.token }}

    - name: ‚úÖ Workflow completed
      run: |
        Write-Host "‚úÖ .exe compilado y publicado en releases/tag/latest"
        Write-Host "üì• URL: https://github.com/${{ github.repository }}/releases/tag/latest"
        Write-Host "üîÑ Los usuarios pueden actualizar desde la app con el bot√≥n 'Buscar Actualizaci√≥n'"

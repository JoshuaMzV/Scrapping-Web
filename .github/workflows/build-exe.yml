name: Build and Release Executable

on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'src/**'
      - 'scrapers/**'
      - 'templates/**'
      - 'static/**'
      - 'build_exe.py'
      - 'requirements.txt'
      - '.github/workflows/build-exe.yml'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable with PyInstaller
      run: python build_exe.py
    
    - name: Check if exe was built
      run: |
        if (!(Test-Path "dist/CatalogoGenerator.exe")) {
          Write-Host "ERROR: CatalogoGenerator.exe not found!"
          exit 1
        }
        Write-Host "CatalogoGenerator.exe built successfully"
        $size = (Get-Item "dist/CatalogoGenerator.exe").Length / 1MB
        Write-Host "File size: $($size.ToString('F1')) MB"
    
    - name: Extract version from settings
      id: version
      run: |
        $content = Get-Content "src/config/settings.py"
        $version = $content | Select-String "VERSION = '([^']+)'" | ForEach-Object { $_.Matches[0].Groups[1].Value }
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Version: $version"
    
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: ${{ github.repository_owner }}
        REPO_NAME: Scrapping-Web
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $tag = "v$version"
        
        # Create release via GitHub API
        $releaseData = @{
          tag_name = $tag
          name = "Catálogo Generator $version"
          draft = $false
          prerelease = $false
          body = @"
        ## Catálogo Generator v$version
        
        ### Características
        - Scraping Nike y Sephora
        - Excel generado automáticamente
        - Interfaz web integrada
        - Actualizaciones desde GitHub
        
        ### Descargar
        - CatalogoGenerator.exe (43.9 MB)
        
        ### Instalación
        1. Descarga CatalogoGenerator.exe
        2. Ejecuta el archivo
        3. Se abrirá en http://127.0.0.1:5000
        
        Compilado automáticamente por GitHub Actions
        "@
        }
        
        $releaseResponse = Invoke-RestMethod `
          -Uri "https://api.github.com/repos/${{ github.repository }}/releases" `
          -Method POST `
          -Headers @{"Authorization"="token $env:GITHUB_TOKEN"} `
          -ContentType "application/json" `
          -Body ($releaseData | ConvertTo-Json)
        
        Write-Host "Release created: $tag"
        
        # Upload asset
        $uploadUrl = $releaseResponse.upload_url -replace '\{.*\}',''
        $asset = Get-Item "dist/CatalogoGenerator.exe"
        
        Invoke-RestMethod `
          -Uri "$uploadUrl/?name=CatalogoGenerator-v$version.exe" `
          -Method POST `
          -Headers @{"Authorization"="token $env:GITHUB_TOKEN"} `
          -ContentType "application/octet-stream" `
          -InFile $asset.FullName
        
        Write-Host "Asset uploaded successfully"

name: Build and Release Executable

on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'src/**'
      - 'scrapers/**'
      - 'templates/**'
      - 'static/**'
      - 'build_exe.py'
      - 'requirements.txt'
      - '.github/workflows/build-exe.yml'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable with PyInstaller
      run: |
        python build_exe.py
    
    - name: Check if exe was built
      run: |
        if (!(Test-Path "dist/CatalogoGenerator.exe")) {
          Write-Host "ERROR: CatalogoGenerator.exe not found!"
          exit 1
        }
        Write-Host "‚úÖ CatalogoGenerator.exe built successfully"
        $size = (Get-Item "dist/CatalogoGenerator.exe").Length / 1MB
        Write-Host "üìä File size: $($size.ToString('F1')) MB"
    
    - name: Extract version from settings
      id: version
      run: |
        $content = Get-Content "src/config/settings.py"
        $version = $content | Select-String "VERSION = '([^']+)'" | ForEach-Object { $_.Matches[0].Groups[1].Value }
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "‚úÖ Version detected: $version"
    
    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ steps.version.outputs.VERSION }}
        name: Cat√°logo Generator v${{ steps.version.outputs.VERSION }}
        artifacts: dist/CatalogoGenerator.exe
        draft: false
        prerelease: false
        body: |
          ## Cat√°logo Generator v${{ steps.version.outputs.VERSION }}

          ### Descargar
          - **CatalogoGenerator.exe** - Aplicaci√≥n completa (43.9 MB)

          ### Caracter√≠sticas
          - Scraping autom√°tico de Nike y Sephora
          - Generaci√≥n de Excel con precios
          - Interfaz web integrada
          - Actualizaciones autom√°ticas desde GitHub

          ### Instalaci√≥n
          1. Descarga CatalogoGenerator.exe
          2. Ejecuta el archivo
          3. Se abrir√° autom√°ticamente en http://127.0.0.1:5000

          ### Notas
          - Los datos se guardan en: C:\Users\{usuario}\AppData\Local\CatalogoGenerator\data\
          - Las actualizaciones se descargan autom√°ticamente
          - Requiere conexi√≥n a internet para el scraping

          Compilado autom√°ticamente por GitHub Actions
